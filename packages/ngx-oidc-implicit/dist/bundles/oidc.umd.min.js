!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common/http"),require("@angular/http"),require("rxjs/Observable"),require("rxjs/add/operator/map")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common/http","@angular/http","rxjs/Observable","rxjs/add/operator/map"],t):t((e.ng=e.ng||{},e.ng.oidc={}),e.ng.core,e.ng.common.http,e.http,e.Rx)}(this,function(e,t,o,r,n){"use strict";var i=function(){function e(e){this._http=e,this._debug=!1,this._debug&&"undefined"!=typeof console?this._log=console.log.bind(console):this._log=function(){}}return e._store=function(e,t){sessionStorage.setItem(e,t)},e._remove=function(e){sessionStorage.removeItem(e)},e._read=function(e){return sessionStorage.getItem(e)},e._epoch=function(){return Math.round((new Date).getTime()/1e3)},e._generateState=function(){for(var e="",t="0123456789",o=0;o<5;o++)e+=t.charAt(Math.floor(Math.random()*t.length)),e+=t.charAt(Math.floor(Math.random()*t.length)),e+=t.charAt(Math.floor(Math.random()*t.length)),e+="-",e+=t.charAt(Math.floor(Math.random()*t.length)),e+=t.charAt(Math.floor(Math.random()*t.length)),e+=t.charAt(Math.floor(Math.random()*t.length));return e},e._generateNonce=function(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;o<25;o++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},e._createURLParameters=function(e){var t=new r.URLSearchParams;for(var o in e)e.hasOwnProperty(o)&&t.set(o,e[o]);return t.toString()},e.prototype.getCsrfToken=function(){return this._log("Get CSRF token from Authorisation"),this._http.post(this.config.csrf_token_endpoint,"",{withCredentials:!0})},e.prototype.getStoredCsrfToken=function(){return this._log("CSRF Token from storage",e._read("_csrf")),e._read("_csrf")},e.prototype.getStoredToken=function(){var e=this._getStoredTokens(),t=this._cleanExpiredTokens(e);return this._log("-- tokens",JSON.stringify({tokens:e})),t.length<1?null:(this._log("Valid token returned from session storage",t[0]),t[0])},e.prototype.cleanSessionStorage=function(e){var t=this;void 0===e&&(e=[""+this.config.provider_id]),e.forEach(function(e){t.deleteStoredTokens(e),t._deleteState(e),t._deleteNonce(e),t._deleteSessionId(e)}),this._deleteStoredCsrfToken()},e.prototype.isSessionAlive=function(){return this._log("Get Session Alive info from SSO"),this._http.get(this.config.is_session_alive_endpoint+"/"+this._getSessionId())},e.prototype.getAuthHeader=function(){var e=this.getStoredToken();return e?this.config.token_type+" "+e.access_token:null},e.prototype.deleteStoredTokens=function(t){void 0===t&&(t=""+this.config.provider_id),this._log("Removed Tokens from session storage: "+t),e._remove(t+"-token")},e.prototype.authorizeRedirect=function(){this.cleanSessionStorage();var t=this._getAuthorizeParams(),o=this._getURLParameters();o.error?this._log("Error in authorize redirect: "+o.error):(this._log("Do authorisation redirect to SSO with options:",t),window.location.href=this.config.authorize_endpoint+"?"+e._createURLParameters(t))},e.prototype.doSessionUpgradeRedirect=function(t){var o={session_upgrade_token:t.session_upgrade_token,redirect_uri:this.config.redirect_uri+"?flush_state=true"};this._log("Session upgrade function triggered with token: ",t.session_upgrade_token),window.location.href=this.config.authorisation+"/sso/upgrade-session?"+e._createURLParameters(o)},e.prototype.checkSession=function(){var t=this,o=this._getURLParameters(window.location.href),r=this._getHashFragmentParameters(e._read("hash_fragment"));return this._log("Check session with params:",o),new n.Observable(function(n){t._log("Flush state ?",o.flush_state),o.flush_state&&(t.cleanSessionStorage(),t._log("Flush state present, so cleaning the storage")),t.getStoredToken()?(t._log("Local token found, you may proceed"),n.next(!0),n.complete()):t.getCsrfToken().subscribe(function(o){if(e._store("_csrf",o.csrf_token),r.access_token&&r.state){t._log("Access Token found in session storage temp, validating it");var i=t._getState();r.state===i.state?(t._log("State from URL validated against state in session storage state object",i),t._validateToken(r).map(function(e){return e.json()}).subscribe(function(e){t._log("Token validated by backend",e),t._storeToken(r),t._saveSessionId(e.user_session_id),t._log("Token from URL validated, you may proceed."),n.next(!0),n.complete()},function(e){t._log("Token NOT validated by backend",e),n.next(!1),n.complete()})):(t._log("State NOT valid"),n.next(!1),n.complete())}else r.session_upgrade_token?(t._log("Session Upgrade Token found in URL"),t.doSessionUpgradeRedirect(r)):(t._log("No valid token in Storage or URL, Authorize Redirect!"),t.authorizeRedirect(),n.next(!1),n.complete())})})},e.prototype._validateToken=function(e){var t={nonce:this._getNonce(),id_token:e.id_token,access_token:e.access_token};return this._log("Validate token with Hawaii Backend"),this._http.post(this.config.validate_token_endpoint,t)},e.prototype._postSessionUpgrade=function(e){return this._log("Posting session upgrade token to backend"),this._http.post(this.config.upgrade_session_endpoint,e)},e.prototype._saveState=function(t){this._log("State saved"),e._store(this.config.provider_id+"-state",JSON.stringify(t))},e.prototype._getState=function(){return this._log("Got state from storage",e._read(this.config.provider_id+"-state")),JSON.parse(e._read(this.config.provider_id+"-state"))},e.prototype._deleteState=function(t){void 0===t&&(t=""+this.config.provider_id),this._log("Deleted state: "+t),e._remove(t+"-state")},e.prototype._saveNonce=function(t){e._store(this.config.provider_id+"-nonce",t)},e.prototype._getNonce=function(){return e._read(this.config.provider_id+"-nonce")},e.prototype._deleteNonce=function(t){void 0===t&&(t=""+this.config.provider_id),e._remove(t+"-nonce")},e.prototype._saveSessionId=function(t){e._store(this.config.provider_id+"-session-id",t)},e.prototype._getSessionId=function(){return e._read(this.config.provider_id+"-session-id")},e.prototype._deleteSessionId=function(t){void 0===t&&(t=""+this.config.provider_id),e._remove(t+"-session-id")},e.prototype._storeTokens=function(t){this._log("Saved Tokens to session storage"),e._store(this.config.provider_id+"-token",JSON.stringify(t))},e.prototype._deleteStoredCsrfToken=function(){this._log("Removed CSRF Token from session storage"),e._remove("_csrf")},e.prototype._getStoredTokens=function(){return this._log("Got Tokens from session storage with name '"+this.config.provider_id+"-token'"),JSON.parse(e._read(this.config.provider_id+"-token"))||[]},e.prototype._cleanExpiredTokens=function(t){var o,r=this,n=e._epoch();return o=t.filter(function(e){return r._log("Stored token",e.expires,n+5),e.expires&&e.expires>n+5}),this._log("Clean tokens returned:",o),o},e.prototype._storeToken=function(t){var o,r=this._getStoredTokens();t.expires=e._epoch()+(parseInt(t.expires_in,10)-30),r.unshift(t),o=this._cleanExpiredTokens(r),this._storeTokens(o)},e.prototype._getHashFragmentParameters=function(t){var o,r={};if(t){for(var n=0,i=o=t.split("&");n<i.length;n++){var s=i[n].split("=");r[s[0]]=s[1]}e._remove("hash_fragment"),this._log("Hash Fragment params from sessionStorage",r)}return r},e.prototype._getURLParameters=function(e){void 0===e&&(e=window.location.href);var t,o,r={},n=e.indexOf("?"),i=e.indexOf("#");if(-1===n&&-1===i)return r;-1!==n&&(t=e.substring(n+1)),-1!==i&&(t=e.substring(i+1));for(var s=0,a=o=t.split("&");s<a.length;s++){var d=a[s].split("=");r[d[0]]=d[1]}return this._log("URL params",r),r},e.prototype._getAuthorizeParams=function(){var t=this._getState()||{state:e._generateState(),providerId:this.config.provider_id},o=e._generateNonce(),r={state:t.state,nonce:o,authorization:this.config.authorisation,providerId:this.config.provider_id,client_id:this.config.client_id,response_type:this.config.response_type,redirect_uri:this.config.redirect_uri,scope:this.config.scope};return this._saveState(t),this._saveNonce(o),this._log("Gather the Authorize Params",r),r},e}();i.decorators=[{type:t.Injectable}],i.ctorParameters=function(){return[{type:o.HttpClient}]};var s=function(){function e(){}return e.forRoot=function(){return{ngModule:e,providers:[i]}},e.forChild=function(){return{ngModule:e,providers:[i]}},e}();s.decorators=[{type:t.NgModule}],s.ctorParameters=function(){return[]},e.OidcModule=s,e.OidcService=i,Object.defineProperty(e,"__esModule",{value:!0})});